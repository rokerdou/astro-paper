---
import IconX from "@/assets/icons/IconX.svg";
import IconMoon from "@/assets/icons/IconMoon.svg";
import IconSearch from "@/assets/icons/IconSearch.svg";
import IconSunHigh from "@/assets/icons/IconSunHigh.svg";
import IconMenuDeep from "@/assets/icons/IconMenuDeep.svg";
import IconRss from "@/assets/icons/IconRss.svg";
import LinkButton from "./LinkButton.astro";
import { SITE } from "@/config";
import { getCollection } from "astro:content";
import getUniqueTags from "@/utils/getUniqueTags";

const { pathname } = Astro.url;

// Remove trailing slash from current pathname if exists
const currentPath =
  pathname.endsWith("/") && pathname !== "/" ? pathname.slice(0, -1) : pathname;

const isActive = (path: string) => {
  const currentPathArray = currentPath.split("/").filter(p => p.trim());
  const pathArray = path.split("/").filter(p => p.trim());

  return currentPath === path || currentPathArray[0] === pathArray[0];
};

// 获取所有 tags 用于导航栏显示
const posts = await getCollection("blog");
const allTags = getUniqueTags(posts);

// 选择最常用的几个 tags 显示在导航栏（最多显示6个）
const topTags = allTags.slice(0, 6).map(({ tag, tagName }) => ({
  name: tagName,
  path: `/tags/${tag}/`
}));
---

<header class="bg-background shadow-sm sticky top-0 z-50 border-b border-border">
  <a
    id="skip-to-content"
    href="#main-content"
    class="absolute start-16 -top-full z-50 bg-background px-3 py-2 text-accent backdrop-blur-lg transition-all focus:top-4"
  >
    Skip to content
  </a>

  {/* 主导航栏 */}
  <div class="mx-auto max-w-7xl">
    <div class="flex items-center justify-between px-4 sm:px-6 h-16">
      {/* Logo */}
      <div class="flex-shrink-0 flex items-center">
        <a href="/" class="flex items-center gap-3 group">
          <div class="bg-foreground text-background font-mono text-xs px-1.5 py-0.5 rounded font-bold group-hover:scale-110 transition-transform">
            &lt;/&gt;
          </div>
          <span class="text-xl font-bold tracking-tight group-hover:text-accent transition-colors">
            {SITE.title}
          </span>
        </a>
      </div>

      {/* 桌面端右侧导航 */}
      <div class="hidden md:flex items-center space-x-6">
        <a href="/about" class="text-sm font-medium text-foreground/70 hover:text-accent transition-colors">
          ABOUT
        </a>
        <a href="/rss.xml" class="text-sm font-medium text-foreground/70 hover:text-accent transition-colors flex items-center gap-1">
          RSS
          <IconRss width={12} height={12} class="stroke-current" />
        </a>
        <div class="w-px h-4 bg-border"></div>
        <LinkButton
          href="/search"
          class="text-foreground/70 hover:text-accent transition-colors"
          ariaLabel="search"
          title="Search"
        >
          <IconSearch width={20} height={20} />
          <span class="sr-only">Search</span>
        </LinkButton>
        {
          SITE.lightAndDarkMode && (
            <button
              id="theme-btn"
              class="focus-outline text-foreground/70 hover:text-accent transition-colors"
              title="Toggle theme"
              aria-label="auto"
              aria-live="polite"
            >
              <IconMoon width={20} height={20} class="scale-100 rotate-0 transition-all dark:scale-0 dark:-rotate-90" />
              <IconSunHigh width={20} height={20} class="absolute scale-0 rotate-90 transition-all dark:scale-100 dark:rotate-0" />
            </button>
          )
        }
      </div>

      {/* 移动端菜单按钮 */}
      <div class="md:hidden flex items-center gap-4">
        {
          SITE.lightAndDarkMode && (
            <button
              id="theme-btn-mobile"
              class="focus-outline text-foreground/70 hover:text-accent transition-colors p-2"
              title="Toggle theme"
              aria-label="auto"
              aria-live="polite"
            >
              <IconMoon width={20} height={20} class="scale-100 rotate-0 transition-all dark:scale-0 dark:-rotate-90" />
              <IconSunHigh width={20} height={20} class="absolute scale-0 rotate-90 transition-all dark:scale-100 dark:rotate-0" />
            </button>
          )
        }
        <button
          id="menu-btn"
          class="focus-outline p-2 text-foreground hover:text-accent"
          aria-label="Open Menu"
          aria-expanded="false"
          aria-controls="menu-items"
        >
          <IconX id="close-icon" class="hidden" width={24} height={24} />
          <IconMenuDeep id="menu-icon" width={24} height={24} />
        </button>
      </div>
    </div>
  </div>

  {/* 分类导航栏 - 桌面端 */}
  <div class="hidden md:block border-t border-border bg-background/50 backdrop-blur-sm">
    <nav class="max-w-7xl mx-auto px-4 sm:px-6 h-12 flex items-center justify-center space-x-1">
      {topTags.map((tag, index) => (
        <>
          <a
            href={tag.path}
            class:list={[
              "px-3 text-sm font-medium transition-colors",
              isActive(tag.path) ? "text-accent" : "text-foreground/60 hover:text-foreground"
            ]}
          >
            {tag.name}
          </a>
          {index < topTags.length - 1 && (
            <span class="text-border text-xs">/</span>
          )}
        </>
      ))}
    </nav>
  </div>

  {/* 移动端菜单 */}
  <div id="menu-items" class="hidden md:hidden border-t border-border bg-background">
    <div class="px-2 pt-2 pb-3 space-y-1">
      <a href="/posts" class="block px-3 py-2 rounded-md text-base font-medium text-foreground/80 hover:text-foreground hover:bg-accent/10">
        Posts
      </a>
      <a href="/tags" class="block px-3 py-2 rounded-md text-base font-medium text-foreground/80 hover:text-foreground hover:bg-accent/10">
        Tags
      </a>
      <a href="/search" class="block px-3 py-2 rounded-md text-base font-medium text-foreground/80 hover:text-foreground hover:bg-accent/10">
        Search
      </a>
      <div class="border-t border-border my-2"></div>
      <a href="/about" class="block px-3 py-2 rounded-md text-base font-medium text-foreground/80 hover:text-foreground hover:bg-accent/10">
        About
      </a>
      <a href="/rss.xml" class="block px-3 py-2 rounded-md text-base font-medium text-foreground/80 hover:text-foreground hover:bg-accent/10">
        RSS
      </a>
    </div>
  </div>
</header>

<script>
  function toggleNav() {
    const menuBtn = document.querySelector("#menu-btn");
    const menuItems = document.querySelector("#menu-items");
    const menuIcon = document.querySelector("#menu-icon");
    const closeIcon = document.querySelector("#close-icon");

    if (!menuBtn || !menuItems || !menuIcon || !closeIcon) return;

    menuBtn.addEventListener("click", () => {
      const openMenu = menuBtn.getAttribute("aria-expanded") === "true";

      menuBtn.setAttribute("aria-expanded", openMenu ? "false" : "true");
      menuBtn.setAttribute("aria-label", openMenu ? "Open Menu" : "Close Menu");

      menuItems.classList.toggle("hidden");
      menuIcon.classList.toggle("hidden");
      closeIcon.classList.toggle("hidden");
    });
  }

  toggleNav();

  // Runs on view transitions navigation
  document.addEventListener("astro:after-swap", toggleNav);
</script>
